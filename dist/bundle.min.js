const gulp=require("gulp"),babel=require("gulp-babel"),uglify=require("gulp-uglify"),concat=require("gulp-concat");gulp.task("build",function(){return gulp.src("src/**/*.js").pipe(babel()).pipe(uglify()).pipe(concat("bundle.min.js")).pipe(gulp.dest("dist"))}),gulp.task("watch",function(){gulp.watch("src/**/*.js",gulp.series("build"))});
const express=require("express"),app=express(),port=3010,ffmpeg=require("ffmpeg-static"),cp=require("child_process"),path=require("path"),fs=require("fs"),bodyParser=require("body-parser"),ytdl=require("ytdl-core");__dirname=path.resolve(__dirname),app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json()),app.get("/",function(e,p){p.sendFile(__dirname+"/index.html")}),app.get("/video/1080/:id",async(e,p)=>{let i;i="undefined"==e.params.id?"https://www.youtube.com/watch?v=JfVOs4VSpmA":e.params.id,p.header("Content-Disposition","attachment;  filename=.mp4");var e=ytdl(i,{filter:"videoonly"}),t=ytdl(i,{filter:"audioonly",highWaterMark:1<<25}),r=cp.spawn(ffmpeg,["-i","pipe:3","-i","pipe:4","-map","0:v","-map","1:a","-c:v","copy","-c:a","libmp3lame","-crf","27","-preset","veryfast","-movflags","frag_keyframe+empty_moov","-f","mp4","-loglevel","error","-"],{stdio:["pipe","pipe","pipe","pipe","pipe"]});e.pipe(r.stdio[3]),t.pipe(r.stdio[4]),r.stdio[1].pipe(p);let a="";r.stdio[2].on("data",e=>{a+=e.toString()}),r.on("exit",e=>{1===e&&console.error(a)})}),app.get("/video/720/:id",async(e,p)=>{let i;i="undefined"==e.params.id?"https://www.youtube.com/watch?v=JfVOs4VSpmA":e.params.id,ytdl(i,{filter:"videoandaudio"}).pipe(p)}),app.listen(port,()=>{console.log("Example app listening at http://localhost:"+port)});